# 微信公众号关注事件处理指南

## 概述

您的微信公众号现在已经支持处理用户关注事件，当有新用户关注您的公众号时，系统会自动发送个性化的欢迎消息。

## 功能特性

### ✅ 已实现的功能

1. **关注事件处理** - 新用户关注时自动发送欢迎消息
2. **取消关注事件处理** - 记录用户取消关注（不发送消息）
3. **菜单点击事件处理** - 响应自定义菜单的点击
4. **文本消息回复** - 智能回复用户发送的文本消息

### 🎯 事件处理流程

```
用户关注公众号
     ↓
微信服务器推送subscribe事件
     ↓
您的服务器接收并解析事件
     ↓
调用get_welcome_message()生成欢迎内容
     ↓
返回XML格式的欢迎消息
     ↓
用户收到欢迎消息
```

## 关注事件消息内容

当用户关注您的公众号时，会收到以下欢迎消息：

```
🎉 欢迎关注源源和娇娇的家！

感谢您的关注，这里是源源和娇娇分享生活点滴的温馨小窝~

🏠 在这里您可以：
• 了解我们的日常生活
• 分享有趣的话题
• 获取最新的动态更新

💬 您可以随时发送消息与我们互动，我们会尽快回复！

回复"帮助"查看更多功能介绍
```

## 自定义欢迎消息

### 修改文本欢迎消息

在 `handle.py` 文件中找到 `get_welcome_message()` 方法，修改其中的内容：

```python
def get_welcome_message(self):
    welcome_msg = """您的自定义欢迎消息内容"""
    return welcome_msg
```

### 使用图文消息（高级）

如果想发送更丰富的图文消息，可以修改关注事件处理部分：

```python
if recMsg.Event == 'subscribe':
    # 使用图文消息替代文本消息
    reply_str = self.send_rich_welcome_message(toUser, fromUser)
    web.header('Content-Type', 'application/xml; charset=utf-8')
    return reply_str
```

## 菜单功能

系统已预设了三个菜单响应：

1. **HELP** - 功能介绍
2. **ABOUT** - 关于我们
3. **CONTACT** - 联系方式

### 添加新菜单

在 `handle_menu_click()` 方法中添加新的菜单响应：

```python
menu_responses = {
    'YOUR_MENU_KEY': '您的菜单回复内容',
    # ... 其他菜单
}
```

## 测试说明

### 本地测试

1. 启动您的服务器：
   ```bash
   python main.py
   ```

2. 运行测试脚本：
   ```bash
   python test_subscribe_event.py
   ```

### 微信公众平台测试

1. 在微信公众平台后台配置服务器地址
2. 使用测试号关注功能进行真实测试

## 部署注意事项

### 1. 服务器要求
- 需要公网可访问的域名或IP
- 支持HTTP/HTTPS协议
- 端口80或443（推荐）

### 2. 微信公众平台配置
- 服务器地址：`http://your-domain.com/wx`
- Token：与代码中的token保持一致
- 消息加解密方式：建议选择"明文模式"（测试时）

### 3. 安全建议
- 生产环境使用HTTPS
- 定期更换Token
- 添加IP白名单验证

## 常见问题

### Q1: 用户关注后没有收到欢迎消息？
- 检查服务器日志，确认是否收到关注事件
- 验证微信公众平台的服务器配置
- 确认返回的XML格式正确

### Q2: 如何知道有新用户关注？
- 查看服务器日志中的"新用户关注事件"信息
- 可以添加数据库记录用户信息
- 集成邮件或短信通知

### Q3: 欢迎消息太长被截断？
- 微信单条消息有长度限制
- 考虑使用图文消息
- 分多条消息发送

## 扩展功能建议

### 1. 用户数据收集
```python
# 在关注事件中添加用户信息收集
def save_user_info(self, openid):
    # 调用微信API获取用户信息
    # 保存到数据库
    pass
```

### 2. 个性化欢迎消息
```python
def get_welcome_message(self, user_info=None):
    if user_info and user_info.get('nickname'):
        return f"欢迎 {user_info['nickname']} 关注我们！"
    return "欢迎关注！"
```

### 3. 关注统计
```python
def update_subscribe_stats(self):
    # 更新关注人数统计
    # 记录关注时间、来源等信息
    pass
```

## 联系支持

如果您在使用过程中遇到问题，欢迎：
- 查看微信公众平台开发文档
- 检查服务器日志文件
- 测试各个功能模块